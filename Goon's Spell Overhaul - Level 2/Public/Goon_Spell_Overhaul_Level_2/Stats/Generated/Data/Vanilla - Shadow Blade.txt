// ==================================== Shadow Blade ====================================
// Bug Fix: Shadow Blade Ring no longer needlessly breaks concentration when unequipped. 
// Changes: It's a magical weapon, the summoner has innate proficiency with it, it uses the summoner's spell casting ability for attacks. Lasts until long rest. Damage starts at 1d6 and scales to 5d6 with upcasting to level 9 spell slots. Concentration requirement removed.
// Changes: The weapon itself is now a proper magical scimitar, with all that entails. 
// Changes: The wielder has innate proficiency with the weapon.
// Changes: The wielders spellcasting ability modifier is now used for attack rolls.
// Changes: Damage starts at 1d6 Psychic damage without being upcast, and scales to 5d6 Psychic damage with upcasting using a level 9 spell slot.
// TODO: Shadow Blade's Advantage against obscured targets is only applied to attacks with the weapon itself. (The fix for this will be enabled once I've completed a rather verbose project.)

new entry "MAG_SHADOW_BLADE_RING_TECHNICAL"
type "StatusData"
data "StatusType" "BOOST"
using "MAG_SHADOW_BLADE_RING_TECHNICAL"
// data "OnRemoveFunctors" "IF(HasStatus('MAG_SHADOW_BLADE_OWNER')):BreakConcentration()"
data "OnRemoveFunctors" ""

// Patch #8 technical fixes so the buffs aren't removed when other weapon statuses are removed (redundant)
new entry "SHADOWBLADE_TECHNICAL_1"
type "StatusData"
data "StatusType" "BOOST"
using "SHADOWBLADE_TECHNICAL_1"
// data "RemoveConditions" "not HasStatus('MAG_SHADOW_BLADE_OWNER')"
data "RemoveConditions" "not HasStatus('MAG_SHADOW_BLADE_OWNER', GetSummoner(context.Source))"

new entry "SHADOWBLADE_TECHNICAL_2"
type "StatusData"
data "StatusType" "BOOST"
using "SHADOWBLADE_TECHNICAL_2"
// data "RemoveConditions" "not HasStatus('MAG_SHADOW_BLADE_OWNER')"
data "RemoveConditions" "not HasStatus('MAG_SHADOW_BLADE_OWNER', GetSummoner(context.Source))"

new entry "MAG_SHADOW_BLADE_OWNER"
type "StatusData"
data "StatusType" "BOOST"
using "MAG_SHADOW_BLADE_OWNER"
// data "StatusPropertyFlags" "DisableOverhead;DisableCombatlog;DisablePortraitIndicator"
data "StatusPropertyFlags" "DisableOverhead;DisableCombatlog;DisablePortraitIndicator;ApplyToDead"

// Vanilla entries
new entry "WPN_ShadowBlade"
type "Weapon"
// using "WPN_Shortsword_1"
using "WPN_ShadowBlade"
// data "RootTemplate" "66d6cbd5-c231-4fc4-a3b7-80f781b579f7"
// data "Damage Type" "Psychic"
// data "Damage" "2d8"
data "Damage" "1d6"
// data "ValueUUID" "86e7e503-a225-4b48-819e-2e24de1f904a"
// data "DefaultBoosts" "WeaponProperty(Magical);CannotBeDisarmed();HiddenDuringCinematic();"
// data "PersonalStatusImmunities" "WEAPON_COATED_WITH_POISON;POISON_BASIC;POISON_SERPENT_VENOM;POISON_WYVERN;POISON_WYVERN_DIPPED;POISON_PURPLE_WORM;DIPPED_FIRE;DIPPED_POISON;DIPPED_WATER"
// data "PassivesOnEquip" "ShadowBlade_Passive"
// data "Unique" "1"
// data "Weapon Group" "SimpleMeleeWeapon"
// data "Weapon Properties" "Finesse;Light;Melee;Dippable"
// data "Proficiency Group" "Shortswords;SimpleWeapons"

// new entry "ShadowBlade_Passive"
// type "PassiveData"
// using "ShadowBlade_Passive"
// Shadow Blade
// data "DisplayName" "h0160e9efg8974g43d6gb3fcg8d4e9d200a3c;4"
// You have &lt;LSTag Tooltip="Advantage"&gt;Advantage&lt;/LSTag&gt; on &lt;LSTag Tooltip="AttackRoll"&gt;Attack Rolls&lt;/LSTag&gt; against Lightly or Heavily Obscured targets when using this blade.
// data "Description" "ha672fd65g0fe4g4596g9529gce372c013ca1;6"
// Your &lt;LSTag Tooltip="AttackRoll"&gt;Attack Rolls&lt;/LSTag&gt; with this blade have &lt;LSTag Tooltip="Advantage"&gt;Advantage&lt;/LSTag&gt; against Lightly or Heavily Obscured targets.
// data "Description" "h1eec2cd1gc17dg48cdg8982g879f95483b05;1"
// data "BoostConditions" "AttackedWithPassiveSourceWeapon()"
// data "Boosts" "IF(not HasObscuredState(ObscuredState.Clear) and IsMeleeAttack() and IsWeaponAttack()):Advantage(AttackRoll);"
// data "Boosts" "IF((IsAttackType(AttackType.MeleeWeaponAttack) or IsAttackType(AttackType.MeleeOffHandWeaponAttack)) and not HasObscuredState(ObscuredState.Clear)):Advantage(AttackRoll)"

new entry "SHADOW_BLADE"
type "StatusData"
data "StatusType" "EFFECT"
using "SHADOW_BLADE"
// data "Boosts" "Attribute(InventoryBound)"
data "Boosts" "Attribute(InventoryBound);IntrinsicSummonerProficiency();WeaponAttackRollAbilityOverride(SpellCastingAbility)"
data "IsUnique" "1"

// 5E Spells entries
new entry "SHADOW_BLADE_3"
type "StatusData"
data "StatusType" "BOOST"
using "SHADOW_BLADE"
// data "Boosts" "Attribute(InventoryBound);WeaponDamageDieOverride(3d8)"
data "Boosts" "Attribute(InventoryBound);IntrinsicSummonerProficiency();WeaponDamageDieOverride(2d6);WeaponAttackRollAbilityOverride(SpellCastingAbility)"

new entry "SHADOW_BLADE_4"
type "StatusData"
data "StatusType" "BOOST"
using "SHADOW_BLADE"
// data "Boosts" "Attribute(InventoryBound);WeaponDamageDieOverride(4d8)"
data "Boosts" "Attribute(InventoryBound);IntrinsicSummonerProficiency();WeaponDamageDieOverride(3d6);WeaponAttackRollAbilityOverride(SpellCastingAbility)"

new entry "SHADOW_BLADE_5"
type "StatusData"
data "StatusType" "BOOST"
using "SHADOW_BLADE"
// data "Boosts" "Attribute(InventoryBound);WeaponDamageDieOverride(5d8)"
data "Boosts" "Attribute(InventoryBound);IntrinsicSummonerProficiency();WeaponDamageDieOverride(4d6);WeaponAttackRollAbilityOverride(SpellCastingAbility)"

// New entry for level 9 casting
new entry "SHADOW_BLADE_6"
type "StatusData"
data "StatusType" "BOOST"
using "SHADOW_BLADE"
data "Boosts" "Attribute(InventoryBound);IntrinsicSummonerProficiency();WeaponDamageDieOverride(5d6);WeaponAttackRollAbilityOverride(SpellCastingAbility)"

// ==================================== Shadow Blade - Spells ====================================

// Vanilla entry
new entry "Shout_ShadowBlade"
type "SpellData"
data "SpellType" "Shout"
// using "Shout_FlameBlade"
using "Shout_ShadowBlade"
// data "SpellFlags" "IsSpell;HasVerbalComponent;HasSomaticComponent;IsConcentration"
data "SpellFlags" "IsSpell;HasVerbalComponent;HasSomaticComponent"
// data "DescriptionParams" " DealDamage(2d8,Psychic);"
data "DescriptionParams" "DealDamage(1d6,Psychic)"
// data "TooltipUpcastDescription" ""
data "TooltipUpcastDescription" "7bbb79fa-02c7-4f45-a115-1d8e11b96ea0"
// data "TooltipUpcastDescriptionParams" ""
data "TooltipUpcastDescriptionParams" "DealDamage(1d6,Psychic);2"

new entry "Shout_ShadowBlade_Class"
type "SpellData"
data "SpellType" "Shout"
// using "Shout_ShadowBlade"
using "Shout_ShadowBlade_Class"
// data "TooltipUpcastDescription" "feb2f892-b684-442c-b22d-88a3d411a1a2"
data "TooltipUpcastDescription" "7bbb79fa-02c7-4f45-a115-1d8e11b96ea0"
// data "TooltipUpcastDescriptionParams" "DealDamage(1d8,Psychic);DealDamage(2d8,Psychic)"
data "TooltipUpcastDescriptionParams" "DealDamage(1d6,Psychic);2"

// 5e spells entries

// Don't know what's up with this, getting hits from VEO in the ModChanges.txt, yet the spell only exists in 5e Spells lol
// new entry "Shout_ShadowBlade_Ring"
// type "SpellData"
// data "SpellType" "Shout"
// using "Shout_ShadowBlade"
// data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE)"
// data "SpellFlags" "IsSpell;HasVerbalComponent;HasSomaticComponent;SwitchSheathUnsheathOnCast;Force1HSSubSetDuringCast"

new entry "Shout_ShadowBlade_3"
type "SpellData"
data "SpellType" "Shout"
// using "Shout_ShadowBlade"
using "Shout_ShadowBlade_3"
// data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,10,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_3);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, 10)"
data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_3);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1)"
// data "DescriptionParams" "DealDamage(3d8,Psychic)"
data "DescriptionParams" "DealDamage(2d6,Psychic)"

new entry "Shout_ShadowBlade_Class_3"
type "SpellData"
data "SpellType" "Shout"
// using "Shout_ShadowBlade_Class"
using "Shout_ShadowBlade_Class_3"
// data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,'ShadowBlade',SHADOW_BLADE,SHADOWBLADE_TECHNICAL_1);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1);"
data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_3);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1)"
// data "DescriptionParams" " DealDamage(3d8,Psychic);"
data "DescriptionParams" "DealDamage(2d6,Psychic)"

new entry "Shout_ShadowBlade_4"
type "SpellData"
data "SpellType" "Shout"
// using "Shout_ShadowBlade"
using "Shout_ShadowBlade_4"
// data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,10,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_3);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, 10)"
data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_3);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1)"
// data "DescriptionParams" "DealDamage(3d8,Psychic)"
data "DescriptionParams" "DealDamage(2d6,Psychic)"

new entry "Shout_ShadowBlade_Class_4"
type "SpellData"
data "SpellType" "Shout"
// using "Shout_ShadowBlade_Class"
using "Shout_ShadowBlade_Class_4"
// data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,'ShadowBlade',SHADOW_BLADE,SHADOWBLADE_TECHNICAL_1);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1);"
data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_3);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1)"
// data "DescriptionParams" " DealDamage(3d8,Psychic);"
data "DescriptionParams" "DealDamage(2d6,Psychic)"

new entry "Shout_ShadowBlade_5"
type "SpellData"
data "SpellType" "Shout"
// using "Shout_ShadowBlade"
using "Shout_ShadowBlade_5"
// data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,10,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_4);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, 10)"
data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_4);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1)"
// data "DescriptionParams" "DealDamage(4d8,Psychic)"
data "DescriptionParams" "DealDamage(3d6,Psychic)"

new entry "Shout_ShadowBlade_Class_5"
type "SpellData"
data "SpellType" "Shout"
// using "Shout_ShadowBlade_Class"
using "Shout_ShadowBlade_Class_5"
// data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,'ShadowBlade',SHADOW_BLADE,SHADOWBLADE_TECHNICAL_2);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1);"
data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_4);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1)"
// data "DescriptionParams" " DealDamage(4d8,Psychic);"
data "DescriptionParams" "DealDamage(3d6,Psychic)"

new entry "Shout_ShadowBlade_6"
type "SpellData"
data "SpellType" "Shout"
// using "Shout_ShadowBlade"
using "Shout_ShadowBlade_6"
// data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,10,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_4);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, 10)"
data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_4);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1)"
// data "DescriptionParams" "DealDamage(4d8,Psychic)"
data "DescriptionParams" "DealDamage(3d6,Psychic)"

new entry "Shout_ShadowBlade_Class_6"
type "SpellData"
data "SpellType" "Shout"
// using "Shout_ShadowBlade_Class"
using "Shout_ShadowBlade_Class_6"
// data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,'ShadowBlade',SHADOW_BLADE,SHADOWBLADE_TECHNICAL_2);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1);"
data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_4);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1)"
// data "DescriptionParams" " DealDamage(4d8,Psychic);"
data "DescriptionParams" "DealDamage(3d6,Psychic)"

new entry "Shout_ShadowBlade_7"
type "SpellData"
data "SpellType" "Shout"
// using "Shout_ShadowBlade"
using "Shout_ShadowBlade_7"
// data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,10,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_5);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, 10)"
data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_5);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1)"
// data "DescriptionParams" "DealDamage(5d8,Psychic)"
data "DescriptionParams" "DealDamage(4d6,Psychic)"

// TODO: These "Class" entries from 7-9 are guesswork, based purely on assumption for how Celes is handling it with Expansion
new entry "Shout_ShadowBlade_Class_7"
type "SpellData"
data "SpellType" "Shout"
// using "Shout_ShadowBlade_Class"
using "Shout_ShadowBlade_Class_7"
// data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,'ShadowBlade',SHADOW_BLADE,SHADOWBLADE_TECHNICAL_3);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1);"
data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_5);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1)"
// data "DescriptionParams" " DealDamage(5d8,Psychic);"
data "DescriptionParams" "DealDamage(4d6,Psychic)"

new entry "Shout_ShadowBlade_8"
type "SpellData"
data "SpellType" "Shout"
// using "Shout_ShadowBlade"
using "Shout_ShadowBlade_8"
// data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,10,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_5);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, 10)"
data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_5);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1)"
// data "DescriptionParams" "DealDamage(5d8,Psychic)"
data "DescriptionParams" "DealDamage(4d6,Psychic)"

new entry "Shout_ShadowBlade_Class_8"
type "SpellData"
data "SpellType" "Shout"
// using "Shout_ShadowBlade_Class"
using "Shout_ShadowBlade_Class_8"
// data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,'ShadowBlade',SHADOW_BLADE,SHADOWBLADE_TECHNICAL_3);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1);"
data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_5);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1)"
// data "DescriptionParams" " DealDamage(5d8,Psychic);"
data "DescriptionParams" "DealDamage(4d6,Psychic)"

new entry "Shout_ShadowBlade_9"
type "SpellData"
data "SpellType" "Shout"
// using "Shout_ShadowBlade"
using "Shout_ShadowBlade_9"
// data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,10,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_5);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, 10)"
data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_6);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1)"
// data "DescriptionParams" "DealDamage(5d8,Psychic)"
data "DescriptionParams" "DealDamage(5d6,Psychic)"

new entry "Shout_ShadowBlade_Class_9"
type "SpellData"
data "SpellType" "Shout"
// using "Shout_ShadowBlade_Class"
using "Shout_ShadowBlade_Class_9"
// data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,'ShadowBlade',SHADOW_BLADE,SHADOWBLADE_TECHNICAL_3);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1);"
data "SpellProperties" "AI_IGNORE:SummonInInventory(66d6cbd5-c231-4fc4-a3b7-80f781b579f7,-1,1,true,true,true,,,SHADOW_BLADE,SHADOW_BLADE_6);ApplyStatus(SELF, MAG_SHADOW_BLADE_OWNER, 100, -1)"
// data "DescriptionParams" " DealDamage(5d8,Psychic);"
data "DescriptionParams" "DealDamage(5d6,Psychic)"